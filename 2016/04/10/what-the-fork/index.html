<!DOCTYPE html>
<html ⚡ lang="en">
  <head>
  <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <title>What the Fork</title>
  <meta name="description" content="Exploring fork (2) and sockets in Nim">

  <link rel="canonical" href="https://singularperturbation.github.io/2016/04/10/what-the-fork/">
  <link rel="alternate" type="application/rss+xml" title="Nimprov lessons" href="https://singularperturbation.github.io/feed.xml">

  <script type="application/ld+json">
  
{
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage": "https://singularperturbation.github.io/2016/04/10/what-the-fork/",
  "headline": "What the Fork",
  "datePublished": "2016-04-10T00:00:00-05:00",
  "dateModified": "2016-04-10T00:00:00-05:00",
  "description": "Exploring fork (2) and sockets in Nim",
  "author": {
    "@type": "Person",
    "name": "Sloane Simmons"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Nimprov lessons",
    "logo": {
      "@type": "ImageObject",
      "url": "https://singularperturbation.github.io",
      "width": 60,
      "height": 60
    }
  },
  "image": {
    "@type": "ImageObject",
    "url": "https://singularperturbation.github.io",
    "height": 60,
    "width": 60
  }
}

  </script>

  <style amp-custom>
  
  /* Import ET Book styles
   adapted from https://github.com/edwardtufte/et-book/blob/gh-pages/et-book.css */
@font-face {
  font-family: "et-book";
  src: url("/assets/et-book/et-book-roman-line-figures/et-book-roman-line-figures.eot");
  src: url("/assets/et-book/et-book-roman-line-figures/et-book-roman-line-figures.eot?#iefix") format("embedded-opentype"), url("/assets/et-book/et-book-roman-line-figures/et-book-roman-line-figures.woff") format("woff"), url("/assets/et-book/et-book-roman-line-figures/et-book-roman-line-figures.ttf") format("truetype"), url("/assets/et-book/et-book-roman-line-figures/et-book-roman-line-figures.svg#etbookromanosf") format("svg");
  font-weight: normal;
  font-style: normal; }
@font-face {
  font-family: "et-book";
  src: url("/assets/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.eot");
  src: url("/assets/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.eot?#iefix") format("embedded-opentype"), url("/assets/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.woff") format("woff"), url("/assets/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.ttf") format("truetype"), url("/assets/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.svg#etbookromanosf") format("svg");
  font-weight: normal;
  font-style: italic; }
@font-face {
  font-family: "et-book";
  src: url("/assets/et-book/et-book-bold-line-figures/et-book-bold-line-figures.eot");
  src: url("/assets/et-book/et-book-bold-line-figures/et-book-bold-line-figures.eot?#iefix") format("embedded-opentype"), url("/assets/et-book/et-book-bold-line-figures/et-book-bold-line-figures.woff") format("woff"), url("/assets/et-book/et-book-bold-line-figures/et-book-bold-line-figures.ttf") format("truetype"), url("/assets/et-book/et-book-bold-line-figures/et-book-bold-line-figures.svg#etbookromanosf") format("svg");
  font-weight: bold;
  font-style: normal; }
@font-face {
  font-family: "et-book-roman-old-style";
  src: url("/assets/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.eot");
  src: url("/assets/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.eot?#iefix") format("embedded-opentype"), url("/assets/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.woff") format("woff"), url("/assets/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.ttf") format("truetype"), url("/assets/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.svg#etbookromanosf") format("svg");
  font-weight: normal;
  font-style: normal; }
/* Tufte CSS styles */
html {
  font-size: 15px; }

body {
  width: 87.5%;
  margin-left: auto;
  margin-right: auto;
  padding-left: 12.5%;
  font-family: et-book, Palatino, "Palatino Linotype", "Palatino LT STD", "Book Antiqua", Georgia, serif;
  background-color: #fffff8;
  color: #111;
  max-width: 1400px;
  counter-reset: sidenote-counter; }

h1 {
  font-weight: 400;
  margin-top: 4rem;
  margin-bottom: 1.5rem;
  font-size: 3.2rem;
  line-height: 1; }

h2 {
  font-style: italic;
  font-weight: 400;
  margin-top: 2.1rem;
  margin-bottom: 0;
  font-size: 2.2rem;
  line-height: 1; }

h3 {
  font-style: italic;
  font-weight: 400;
  font-size: 1.7rem;
  margin-top: 2rem;
  margin-bottom: 0;
  line-height: 1; }

p.subtitle {
  font-style: italic;
  margin-top: 1rem;
  margin-bottom: 1rem;
  font-size: 1.8rem;
  display: block;
  line-height: 1; }

.numeral {
  font-family: et-book-roman-old-style; }

.danger {
  color: red; }

article {
  position: relative;
  padding: 5rem 0rem; }

section {
  padding-top: 1rem;
  padding-bottom: 1rem; }

p, ol, ul, .pagination a, .pagination em {
  font-size: 1.4rem; }

p {
  line-height: 2rem;
  margin-top: 1.4rem;
  margin-bottom: 1.4rem;
  padding-right: 0;
  vertical-align: baseline; }

/* Chapter Epigraphs */
div.epigraph {
  margin: 5em 0; }

div.epigraph > blockquote {
  margin-top: 3em;
  margin-bottom: 3em; }

div.epigraph > blockquote, div.epigraph > blockquote > p {
  font-style: italic; }

div.epigraph > blockquote > footer {
  font-style: normal; }

div.epigraph > blockquote > footer > cite {
  font-style: italic; }

/* end chapter epigraphs styles */
blockquote {
  font-size: 1.4rem; }

blockquote p {
  width: 50%; }

blockquote .footer {
  width: 50%;
  font-size: 1.1rem;
  text-align: right; }

ol, ul {
  width: 45%;
  -webkit-padding-start: 5%;
  -webkit-padding-end: 5%; }

li {
  padding: 0.5rem 0; }

figure {
  padding: 0;
  border: 0;
  font-size: 100%;
  font: inherit;
  vertical-align: baseline;
  max-width: 100%;
  -webkit-margin-start: 0;
  -webkit-margin-end: 0;
  margin: 0 0 3em 0; }

figcaption {
  float: right;
  clear: right;
  margin-right: -48%;
  margin-top: 0;
  margin-bottom: 0;
  font-size: 1.1rem;
  line-height: 1.6;
  vertical-align: baseline;
  position: relative;
  max-width: 40%; }

figure.fullwidth figcaption {
  margin-right: 24%; }

/* Links: replicate underline that clears descenders */
a:link, a:visited {
  color: inherit; }

a:link {
  text-decoration: none;
  background: -webkit-linear-gradient(#fffff8, #fffff8), -webkit-linear-gradient(#fffff8, #fffff8), -webkit-linear-gradient(#333, #333);
  background: linear-gradient(#fffff8, #fffff8), linear-gradient(#fffff8, #fffff8), linear-gradient(#333, #333);
  -webkit-background-size: 0.05em 1px, 0.05em 1px, 1px 1px;
  -moz-background-size: 0.05em 1px, 0.05em 1px, 1px 1px;
  background-size: 0.05em 1px, 0.05em 1px, 1px 1px;
  background-repeat: no-repeat, no-repeat, repeat-x;
  text-shadow: 0.03em 0 #fffff8, -0.03em 0 #fffff8, 0 0.03em #fffff8, 0 -0.03em #fffff8, 0.06em 0 #fffff8, -0.06em 0 #fffff8, 0.09em 0 #fffff8, -0.09em 0 #fffff8, 0.12em 0 #fffff8, -0.12em 0 #fffff8, 0.15em 0 #fffff8, -0.15em 0 #fffff8;
  background-position: 0% 93%, 100% 93%, 0% 93%; }

@media screen and (-webkit-min-device-pixel-ratio: 0) {
  a:link {
    background-position-y: 87%, 87%, 87%; } }
a:link::selection {
  text-shadow: 0.03em 0 #b4d5fe, -0.03em 0 #b4d5fe, 0 0.03em #b4d5fe, 0 -0.03em #b4d5fe, 0.06em 0 #b4d5fe, -0.06em 0 #b4d5fe, 0.09em 0 #b4d5fe, -0.09em 0 #b4d5fe, 0.12em 0 #b4d5fe, -0.12em 0 #b4d5fe, 0.15em 0 #b4d5fe, -0.15em 0 #b4d5fe;
  background: #b4d5fe; }

a:link::-moz-selection {
  text-shadow: 0.03em 0 #b4d5fe, -0.03em 0 #b4d5fe, 0 0.03em #b4d5fe, 0 -0.03em #b4d5fe, 0.06em 0 #b4d5fe, -0.06em 0 #b4d5fe, 0.09em 0 #b4d5fe, -0.09em 0 #b4d5fe, 0.12em 0 #b4d5fe, -0.12em 0 #b4d5fe, 0.15em 0 #b4d5fe, -0.15em 0 #b4d5fe;
  background: #b4d5fe; }

/* Sidenotes, margin notes, figures, captions */
img {
  max-width: 100%; }

.sidenote, .marginnote {
  float: right;
  clear: right;
  margin-right: -60%;
  width: 50%;
  margin-top: 0;
  margin-bottom: 0;
  font-size: 1.1rem;
  line-height: 1.3;
  vertical-align: baseline;
  position: relative; }

.table-caption {
  float: right;
  clear: right;
  margin-right: -60%;
  width: 50%;
  margin-top: 0;
  margin-bottom: 0;
  font-size: 1.0rem;
  line-height: 1.6; }

.sidenote-number {
  counter-increment: sidenote-counter; }

.sidenote-number:after, .sidenote:before {
  content: counter(sidenote-counter) " ";
  font-family: et-book-roman-old-style;
  position: relative;
  vertical-align: baseline; }

.sidenote-number:after {
  content: counter(sidenote-counter);
  font-size: 1rem;
  top: -0.5rem;
  left: 0.1rem; }

.sidenote:before {
  content: counter(sidenote-counter) " ";
  top: -0.5rem; }

p, footer, table, div.table-wrapper-small, div.supertable-wrapper > p, div.booktabs-wrapper {
  width: 55%; }

div.fullwidth, table.fullwidth {
  width: 100%; }

div.table-wrapper {
  overflow-x: auto;
  font-family: "Trebuchet MS", "Gill Sans", "Gill Sans MT", sans-serif; }

@media screen and (max-width: 760px) {
  p, h1, h2, h3, footer {
    width: 90%; }

  pre.code {
    width: 87.5%; }

  ul {
    width: 85%; }

  figure {
    max-width: 90%; }

  figcaption, figure.fullwidth figcaption {
    margin-right: 0%;
    max-width: none; }

  blockquote p, blockquote .footer {
    width: 90%; } }
.sans {
  font-family: "Gill Sans", "Gill Sans MT", Calibri, sans-serif;
  letter-spacing: .03em; }

.code {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 1.125rem;
  line-height: 1.6; }

h1 .code, h2 .code, h3 .code {
  font-size: 0.80em; }

.marginnote .code, .sidenote .code {
  font-size: 1rem; }

pre.code {
  width: 52.5%;
  padding-left: 2.5%;
  overflow-x: auto; }

.fullwidth {
  max-width: 90%;
  clear: both; }

span.newthought {
  font-variant: small-caps;
  font-size: 1.2em; }

.margin-toggle {
  display: none; }

.sidenote-number {
  display: inline; }

.margin-toggle:not(.sidenote-number) {
  display: none; }

@media (max-width: 760px) {
  .margin-toggle:not(.sidenote-number) {
    display: none; }

  .sidenote, .marginnote {
    display: none; }

  .margin-toggle:checked + .sidenote,
  .margin-toggle:checked + .marginnote {
    display: block;
    float: left;
    left: 1rem;
    clear: both;
    width: 95%;
    margin: 1rem 2.5%;
    vertical-align: baseline;
    position: relative; }

  label {
    cursor: pointer; }

  pre.code {
    width: 90%;
    padding: 0; }

  .table-caption {
    display: block;
    float: right;
    clear: both;
    width: 98%;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    margin-left: 1%;
    margin-right: 1%;
    vertical-align: baseline;
    position: relative; }

  div.table-wrapper, table, table.booktabs {
    width: 85%; }

  div.table-wrapper {
    border-right: 1px solid #efefef; }

  img {
    width: 100%; } }
/**
 * Syntax highlighting styles
 */
.highlight .c {
  color: #998;
  font-style: italic; }
.highlight .err {
  color: #a61717;
  background-color: #e3d2d2; }
.highlight .k {
  font-weight: bold; }
.highlight .o {
  font-weight: bold; }
.highlight .cm {
  color: #998;
  font-style: italic; }
.highlight .cp {
  color: #999;
  font-weight: bold; }
.highlight .c1 {
  color: #998;
  font-style: italic; }
.highlight .cs {
  color: #999;
  font-weight: bold;
  font-style: italic; }
.highlight .gd {
  color: #000;
  background-color: #fdd; }
.highlight .gd .x {
  color: #000;
  background-color: #faa; }
.highlight .ge {
  font-style: italic; }
.highlight .gr {
  color: #a00; }
.highlight .gh {
  color: #999; }
.highlight .gi {
  color: #000;
  background-color: #dfd; }
.highlight .gi .x {
  color: #000;
  background-color: #afa; }
.highlight .go {
  color: #888; }
.highlight .gp {
  color: #555; }
.highlight .gs {
  font-weight: bold; }
.highlight .gu {
  color: #aaa; }
.highlight .gt {
  color: #a00; }
.highlight .kc {
  font-weight: bold; }
.highlight .kd {
  font-weight: bold; }
.highlight .kp {
  font-weight: bold; }
.highlight .kr {
  font-weight: bold; }
.highlight .kt {
  color: #458;
  font-weight: bold; }
.highlight .m {
  color: #099; }
.highlight .s {
  color: #d14; }
.highlight .na {
  color: #008080; }
.highlight .nb {
  color: #0086B3; }
.highlight .nc {
  color: #458;
  font-weight: bold; }
.highlight .no {
  color: #008080; }
.highlight .ni {
  color: #800080; }
.highlight .ne {
  color: #900;
  font-weight: bold; }
.highlight .nf {
  color: #900;
  font-weight: bold; }
.highlight .nn {
  color: #555; }
.highlight .nt {
  color: #000080; }
.highlight .nv {
  color: #008080; }
.highlight .ow {
  font-weight: bold; }
.highlight .w {
  color: #bbb; }
.highlight .mf {
  color: #099; }
.highlight .mh {
  color: #099; }
.highlight .mi {
  color: #099; }
.highlight .mo {
  color: #099; }
.highlight .sb {
  color: #d14; }
.highlight .sc {
  color: #d14; }
.highlight .sd {
  color: #d14; }
.highlight .s2 {
  color: #d14; }
.highlight .se {
  color: #d14; }
.highlight .sh {
  color: #d14; }
.highlight .si {
  color: #d14; }
.highlight .sx {
  color: #d14; }
.highlight .sr {
  color: #009926; }
.highlight .s1 {
  color: #d14; }
.highlight .ss {
  color: #990073; }
.highlight .bp {
  color: #999; }
.highlight .vc {
  color: #008080; }
.highlight .vg {
  color: #008080; }
.highlight .vi {
  color: #008080; }
.highlight .il {
  color: #099; }

main {
  margin-top: 20px; }

amp-img {
  background-color: grey; }

article {
  padding: 2.5rem 0; }

header {
  margin-top: 20px; }

.post-meta {
  margin-top: 10px; }

pre {
  width: 52.5%;
  padding-left: 2.5%;
  overflow-x: auto; }

@media (max-width: 760px) {
  pre {
    width: 90%;
    padding: 0; } }
code {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 1.125rem;
  line-height: 1.6; }

.tags {
  display: inline;
  padding: 0 0 0 0;
  -webkit-padding-start: 0%;
  -webkit-padding-end: 0%;
  font-size: 15px; }

  </style>



  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>

  <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

  <body>
    <header>
  <div class="page-links">
    <a class="page-link" href="/">Home</a>
    
      
      • <a class="page-link" href="/about/">About</a>
      
    
      
      • <a class="page-link" href="/contact/">Contact</a>
      
    
      
    
      
      • <a class="page-link" href="/tags/">Tags</a>
      
    
      
    
      
    
      
    
      
    
      
    
  </div>
</header>


    <article>

  <h2 itemprop="name"><a href="" itemprop="url">What the Fork</a></h2>

  <div class="post-meta">
    <time datetime="10 April 2016">10 April 2016</time>
    <!-- Tags for an individual post -->
  <br/>
  <p class="tags">
    Tags:
  </p>
  <ul class="tags">
    
      <li class="tags">
        <a href="/tag/nim">Nim</a>
      </li>
    
      <li class="tags">
        <a href="/tag/sockets">sockets</a>
      </li>
    
      <li class="tags">
        <a href="/tag/posix">POSIX</a>
      </li>
    
  </ul>

  </div>

  <section>
    <h1 id="exploring-fork-2-and-sockets-in-nim">Exploring fork (2) and sockets in Nim</h1>

<h2 id="background">Background</h2>
<p>Despite having used Linux for a long time, I hadn’t really done anything low level
enough to require understanding sockets (especially at the POSIX API level).  Abstruse
as it may seem, there’s a lot to be gained by learning about this, as it’s an abstraction
that’s used <a href="http://ruby-doc.org/stdlib-2.3.0/libdoc/socket/rdoc/Socket.html">over</a>
and <a href="https://github.com/apache/thrift/blob/master/lib/go/thrift/socket.go#L37">over</a>
and <a href="https://docs.python.org/3.4/library/socket.html">over again</a>.  While there are
plenty of higher-level interfaces or other abstractions that are important to
network / backend programming<span id="side1" class="margin-toggle sidenote-number"></span>
      <span class="sidenote">Request / response objects from Express, streams, the actor model, etc.</span> the underlying socket primitive is everywhere.</p>

<p>I’ve just started exploring using sockets in earnest (and some lower-level POSIX
APIs), and decided to do so using <a href="https://nim-lang.org">Nim</a>.  What prompted
this?  I read through Ruslan Spivak’s excellent <a href="https://ruslanspivak.com/lsbaws-part3/">blog post</a>
with examples in Python, started reading through
<a href="http://beej.us/guide/bgnet/">Beej’s guide to network programming</a> and wanted to
see if I could implement the examples in my favorite programming language, Nim.
You can find it <a href="https://github.com/singularperturbation/prefork_experiment">here</a></p>

<p>So far, I’ve gotten about as far as redoing the original Python blog post in Nim,
with some minor modifications.<span id="side2" class="margin-toggle sidenote-number"></span>
      <span class="sidenote">Changing the server to echo the response as well as be a plaintext server instead of an HTTP server.</span>  This post (and the
code) is heavily based on Ruslan’s post.</p>

<h2 id="why-nim">Why Nim?</h2>

<p>Nim is a programming language that compiles to C as an intermediate step before it
becomes an executable.  As such, it has <a href="http://nim-lang.org/docs/manual.html#types-cstring-type">excellent</a>
interoperability with C and provides <a href="http://nim-lang.org/docs/posix.html">access</a>
to many POSIX functions.  It’s also very pleasant to program in (in my humble
opinion), with a lot of advanced metaprogramming features, expressive syntax, and
a growing and friendly community.  I wanted to use it for exploring POSIX programming
because:</p>

<ul>
  <li>I knew I would have fun using it</li>
  <li>I thought that a port of Spivak’s example would be fairly close to the original</li>
  <li>It can be low level enough that you still get a very real sense of what’s going on,
rather than just how a language’s wrapper works.</li>
</ul>

<h2 id="posix-apis">POSIX APIs</h2>

<p>POSIX<span id="side3" class="margin-toggle sidenote-number"></span>
      <span class="sidenote"><a href="https://en.wikipedia.org/wiki/POSIX">Wikipedia</a> defines as: The Portable Operating System Interface (POSIX) is a family of standards specified by the IEEE Computer Society for maintaining compatibility between operating systems. POSIX defines the application programming interface (API), along with command line shells and utility interfaces, for software compatibility with variants of Unix and other operating systems.</span>
is implemented by BSD, Linux, and Mac OS X.  Back when there were many rival
implementations of Unix in widespread use, there was a need for vendors to provide
a unified API for programmers to use so that programs could run on a variety of
operating systems with little adaptation.</p>

<p>That’s… the theory, anyway.  In practice, POSIX API calls usually seem like they
provide only the lowest common denominator of what you want, because that’s exactly
how they came to be: an implementation based on what was possible across all of the
competing UNIX operating systems, constrained by the limitations of all.</p>

<p>But they’re better than nothing, and at least they’re fairly stable.  For today,
we’ll be looking at <code class="highlighter-rouge">fork</code> and functions associated with socket programming:
<code class="highlighter-rouge">bind</code>, <code class="highlighter-rouge">listen</code>, <code class="highlighter-rouge">accept</code>, <code class="highlighter-rouge">send</code>, <code class="highlighter-rouge">recv</code>, <code class="highlighter-rouge">signal</code>, and <code class="highlighter-rouge">socket</code>.</p>

<p>All of these can be found in section 2 of your trusty man pages if you’re on Linux,
i.e.:</p>

<p><code class="highlighter-rouge">
$ man 2 signal
</code></p>

<h2 id="what-are-sockets">What are sockets?</h2>

<p>Sockets are a way of sending information across the network or to another UNIX process,
while still pretending that you’re just writing to a file.<span id="side4" class="margin-toggle sidenote-number"></span>
      <span class="sidenote">In UNIX, everything (more or less) is a file, including the standard input, output, and error ‘pipes’ that are given to each process. That’s why you can redirect output so easily with the <code class="highlighter-rouge">&lt;</code>, <code class="highlighter-rouge">&gt;</code>, and <code class="highlighter-rouge">|</code> shell operators - all they’re doing is substituting one file for another, or writing to one process’s standard input while reading another’s standard output.</span></p>

<p>When you create a socket, you can get a file descriptor that can be used for IO
with network devices.  The usual way of doing this is:</p>

<p>1) Use <code class="highlighter-rouge">socket</code> to create the socket object.<br />
2) Use <code class="highlighter-rouge">bind</code> to associate the socket with a given port (for network sockets, which
   is what we’ll restrict ourselves to here).<br />
3) Call <code class="highlighter-rouge">listen</code> to start listening for incoming connections.<br />
4) Call <code class="highlighter-rouge">accept</code>- block until get an incoming connection to the original socket,
 and return a new socket and file descriptor to be used for the incoming connection.</p>

<h3 id="using-sockets-with-nim">Using sockets with Nim</h3>
<p>All of these are functions defined by the POSIX API, and are callable by C.  In Nim,
we have a choice: I can call the <a href="http://nim-lang.org/docs/net.html">net</a> or
<a href="http://nim-lang.org/docs/nativesockets.html">nativesockets</a> modules in the standard
library that provide cross-platform access to sockets, or just call the native
POSIX functions by using the <a href="http://nim-lang.org/docs/posix.html">posix</a> module.</p>

<p><span class="marginnote">If I were writing a <em>real</em> network program in Nim, I would probably use something
higher-level like <a href="https://github.com/dom96/jester">jester</a> for HTTP, or
<a href="http://nim-lang.org/docs/asyncnet.html">asyncnet</a> if doing something that needed
to be at the socket level.  I used Nim for this mostly to learn how the underlying
API worked, explore using <code class="highlighter-rouge">fork</code>, and do so in a language that’s more fun and forgiving
than C.</span></p>

<p>I opted to use the <a href="http://nim-lang.org/docs/net.html">net module</a> to handle creating
the socket objects, since it provided a low level enough API (access to sockets,
binding to address, etc.) while still giving access to a convenience function
like <code class="highlighter-rouge">readLine</code>.  Also, mixing a higher-level module like ‘net’ in the standard
library with native POSIX calls would help show how well Nim can work with C
libraries without any special modifications.</p>

<figure class="highlight">
  <pre><code class="language-nim" data-lang="nim"><span class="k">import</span> <span class="n">net</span><span class="p">,</span> <span class="n">posix</span><span class="p">,</span> <span class="n">strutils</span>

<span class="k">let</span> <span class="n">mySocket</span> <span class="o">=</span> <span class="n">newSocket</span><span class="p">()</span>
<span class="c"># ...</span>
<span class="c"># Preamble removed</span>
<span class="c"># ...</span>

<span class="k">proc </span><span class="nf">main</span><span class="p">()</span> <span class="o">=</span>

  <span class="c"># Allow socket port to be reused on exit so that we don't have</span>
  <span class="c">#to wait for OS to clean up after daemon quits.</span>
  <span class="n">mySocket</span><span class="p">.</span><span class="n">setSockOpt</span><span class="p">(</span><span class="n">opt</span> <span class="o">=</span> <span class="n">OptReuseAddr</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>

  <span class="n">bindAddr</span><span class="p">(</span><span class="n">socket</span> <span class="o">=</span> <span class="n">mySocket</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">Port</span><span class="p">(</span><span class="mi">9093</span><span class="p">))</span>
  <span class="n">mySocket</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>

  <span class="k">let</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">=</span> <span class="n">mySocket</span><span class="p">.</span><span class="n">getLocalAddr</span><span class="p">()</span>
  <span class="n">echo</span> <span class="s">"Listening on: </span><span class="si">$1</span><span class="s">:</span><span class="si">$2</span><span class="s">"</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>

  <span class="c"># Signal handlers</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">exitSuccessfully</span><span class="p">)</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span><span class="n">exitSuccessfully</span><span class="p">)</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span><span class="n">handleChildren</span><span class="p">)</span>

  <span class="c"># ...</span>
  <span class="k">var</span> <span class="n">clientSock</span> <span class="o">=</span> <span class="n">newSocket</span><span class="p">()</span>
  <span class="k">while</span> <span class="kp">true</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">mySocket</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="n">clientSock</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">OSError</span><span class="p">:</span>
      <span class="c"># Explicit type conversion needed to OSError since</span>
      <span class="c"># getCurrentException returns the base class.</span>
      <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">ref</span> <span class="n">OSError</span><span class="p">)</span> <span class="n">getCurrentException</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">errorCode</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">:</span> <span class="k">continue</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">mySocket</span><span class="p">.</span><span class="n">close</span>
        <span class="k">raise</span> <span class="n">e</span></code></pre>
</figure>

<p>(This part establishes a listening socket, waits for a connection, and (on
success), puts the result into the socket <code class="highlighter-rouge">clientSock</code>).  We’ll go into the signal
stuff a bit later on.</p>

<h2 id="what-about-fork">What about fork?</h2>

<p><code class="highlighter-rouge">fork</code> is a system call that allows you to create a new process that inherits all of
the parent process’s state (including file descriptors and sockets).</p>

<h3 id="why-use-it">Why use it?</h3>

<p>When you call <code class="highlighter-rouge">accept</code>, it blocks the process - all the calling process is doing
is waiting for incoming connections.  As such, one process can’t simultaneously
wait for new connections and do any sort of work on a connection that it just
accepted.  This makes for bad latency, especially if each incoming request requires
a lot of work (or needs to wait on a DB connection) in order to respond.</p>

<p>When <code class="highlighter-rouge">fork</code> is called, the newly created ‘child’ process can be used to handle
the current request, and the calling process closes the child socket (the child
process will still be listening on it) and loops back around to wait with <code class="highlighter-rouge">accept</code>
for another incoming connection.  The only indication whether we are in the
parent or child process is <code class="highlighter-rouge">pid</code>, the return value of <code class="highlighter-rouge">fork</code>.</p>

<figure class="highlight">
  <pre><code class="language-nim" data-lang="nim"><span class="c"># Still in the loop from above</span>
<span class="k">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">()</span>
<span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  <span class="c"># Child process, so close the listening socket here.</span>
  <span class="n">mySocket</span><span class="p">.</span><span class="n">close</span>
  <span class="n">clientSock</span><span class="p">.</span><span class="n">handleConnection</span>
  <span class="n">quit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="c"># Main process, close the client socket.</span>
  <span class="n">clientSock</span><span class="p">.</span><span class="n">close</span></code></pre>
</figure>

<p>It’s slightly amazing to me that I can call <code class="highlighter-rouge">fork</code> from the posix module (which
is really just calling the native C <code class="highlighter-rouge">fork</code> function) and install signal handlers
and my Nim program (that has a runtime, however minimal, a garbage collector,
etc.) will ‘just work’ regardless.</p>

<p>The <code class="highlighter-rouge">clientSock.handleConnection</code> part is a call to the <code class="highlighter-rouge">handleConnection</code>
procedure that reads data from the client socket, writes it back out (with a
prefix) and closes the connection.</p>

<figure class="highlight">
  <pre><code class="language-nim" data-lang="nim"><span class="k">proc </span><span class="nf">handleConnection</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">:</span> <span class="k">var</span> <span class="n">Socket</span><span class="p">)</span> <span class="o">=</span>
  <span class="c"># Starting capacity for the string- can grow to be larger if needed</span>
  <span class="k">var</span> <span class="n">inputFromClient</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="n">newStringOfCap</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
  <span class="n">clientSocket</span><span class="p">.</span><span class="n">readLine</span><span class="p">(</span><span class="n">inputFromClient</span><span class="p">)</span>
  <span class="n">clientSocket</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"SERVED BY Nim: "</span> <span class="o">&amp;</span> <span class="n">inputFromClient</span> <span class="o">&amp;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
  <span class="c"># Simulate load but disconnect first</span>
  <span class="n">clientSocket</span><span class="p">.</span><span class="n">close</span>
  <span class="k">discard</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></code></pre>
</figure>

<p>I have it sleep before exiting to simulate the
worker taking some time to process the request.</p>

<p>By using <code class="highlighter-rouge">fork</code>, we don’t have to alter our program design, and (because all of the
state is copied to the child process, not shared) we don’t have to worry about
thread safety.  Ha!  Also (in Linux at least), there is an optimization called
copy-on-write which allows the operating system to avoid taking up as much memory
as would be needed for a full copy unless something is changed.</p>

<h3 id="why-not-use-it--for-everything">Why not use it?  For everything?!</h3>

<ul>
  <li>Forking takes time, meaning that you’ll be slow(er) to respond to requests.</li>
  <li>Forking takes memory, which limits the number of ‘workers’ you can create.</li>
</ul>

<p>Forking spawns a whole new process (it’s not a thread, not a goroutine, and
certainly not a callback in an event loop).  This is beefy, even with the
copy-on-write optimization.</p>

<h2 id="signals">Signals</h2>

<p>In order for things to go smoothly, the parent process has to listen for children
to exit.  Otherwise, they stick around, waiting for a parent’s acknowledgement
that will never come.<span id="side5" class="margin-toggle sidenote-number"></span>
      <span class="sidenote">Sad!</span> In the land of UNIX, telling a
parent process that its child has completed is accomplished by sending the
<code class="highlighter-rouge">SIGCHLD</code> signal to the parent process.</p>

<p>By using the <code class="highlighter-rouge">signal</code> function, we can install a ‘signal handler’ for a specific
signal for that process - in this case, we use <code class="highlighter-rouge">handleChildren</code>:</p>

<figure class="highlight">
  <pre><code class="language-nim" data-lang="nim"><span class="k">proc </span><span class="nf">handleChildren</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="n">cint</span><span class="p">)</span> <span class="p">{.</span><span class="n">noconv</span><span class="p">.}</span> <span class="o">=</span>
  <span class="k">var</span> <span class="n">status</span><span class="p">:</span> <span class="n">cint</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="kp">true</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">posix</span><span class="p">.</span><span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="n">Pid</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">)</span>

    <span class="c"># Return on error or if no child jobs changed state</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">echo</span> <span class="s">"Worker </span><span class="si">$#</span><span class="s"> is shutting down"</span> <span class="o">%</span> <span class="o">[$</span><span class="n">pid</span><span class="o">]</span></code></pre>
</figure>

<p>When the main process gets <code class="highlighter-rouge">SIGCHLD</code>, it’s interrupted and the <code class="highlighter-rouge">handleChildren</code>
procedure is called - this waits in a loop, using the POSIX <code class="highlighter-rouge">waitpid</code> call to
find the process ID of any child process has changed state.  It does this in a
loop so that if many children processes have changed state, the parent process
can continue to acknowledge them exiting - a more naive approach can get
overwhelmed if many are exiting at the same time.</p>

<p>The <code class="highlighter-rouge">WNOHANG</code> option is also from the <code class="highlighter-rouge">posix</code> module, and tells <code class="highlighter-rouge">waitpid</code> to return
immediately if there is no change in the status of any child processes.  This way, we
aren’t stuck waiting for child processes forever.</p>

<p>(In addition to the signal handler for <code class="highlighter-rouge">SIGCHLD</code>, there are also signal handlers for
<code class="highlighter-rouge">SIGTERM</code> and <code class="highlighter-rouge">SIGINT</code> to allow graceful shutdown if <code class="highlighter-rouge">Ctrl-C</code> is pressed).</p>

<h2 id="interrupts">Interrupts</h2>

<p>In the native C version of <code class="highlighter-rouge">accept</code> and <code class="highlighter-rouge">recv</code> (getting data from a socket),
there is no exception thrown if there is an interrupt (C can’t!) - instead, control
is taken away to the signal handler function, and the call returns an error
code of the special <code class="highlighter-rouge">EINTR</code> value<span id="side7" class="margin-toggle sidenote-number"></span>
      <span class="sidenote">If you want more information about EINTR, I found <a href="http://250bpm.com/blog:12">this</a> to be very informative.</span>,
which indicates that the function was interrupted.</p>

<p>In Nim, when <code class="highlighter-rouge">accept</code> or similar is interrupted, this is instead an exception of
type <code class="highlighter-rouge">OSError</code>, but we can listen for it by catching the exception and checking
whether or not the error code on the exception is equal to <code class="highlighter-rouge">EINTR</code> from the
posix module; if it is, we just restart the loop and keep listening for new
connections.</p>

<hr />

<p>So, that’s a little tour of using Nim with POSIX calls in order to create an
authentic 80s-style forking server.  Hope it was fun!  I tested only on Debian
Linux, but I’d be interested to see if it works on Mac OS X or FreeBSD if
someone tries it out.</p>

  </section>

    <footer class="site-footer">
   <section class="copyright">All content copyright <a href="mailto:sloanes DOT k AT gmail DOT com">Sloane Simmons</a> &copy; 2016 &bull; All rights reserved.</section>
</footer>


  </div>
</article>

  </body>
</html>
